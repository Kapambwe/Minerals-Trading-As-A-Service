@page "/monthly-reports"
@using Platform.Trading.Management.Models
@using Platform.Trading.Management.Services.Interfaces
@using Platform.Trading.Management.Components.Dialogs
@inject IMonthlyProcessingReportService MonthlyProcessingReportService
@inject DialogService DialogService
@inject NotificationService NotificationService

<PageTitle>Monthly Processing Reports</PageTitle>

<RadzenStack Gap="1rem">
    <RadzenRow>
        <RadzenColumn Size="12">
            <RadzenText TextStyle="TextStyle.H3" TagName="TagName.H1">Monthly Processing Reports</RadzenText>
            <RadzenText TextStyle="TextStyle.Body1">Overview of monthly trading activities and compliance</RadzenText>
        </RadzenColumn>
    </RadzenRow>

    <RadzenRow>
        <RadzenColumn Size="12">
            <RadzenCard>
                <RadzenRow>
                    <RadzenColumn Size="3">
                        <RadzenStack Gap="0.5rem">
                            <RadzenText TextStyle="TextStyle.Overline">Total Reports</RadzenText>
                            <RadzenText TextStyle="TextStyle.H5">@totalReports</RadzenText>
                        </RadzenStack>
                    </RadzenColumn>
                    <RadzenColumn Size="3">
                        <RadzenStack Gap="0.5rem">
                            <RadzenText TextStyle="TextStyle.Overline">Finalized Reports</RadzenText>
                            <RadzenText TextStyle="TextStyle.H5" Style="color: green;">@finalizedReports</RadzenText>
                        </RadzenStack>
                    </RadzenColumn>
                    <RadzenColumn Size="3">
                        <RadzenStack Gap="0.5rem">
                            <RadzenText TextStyle="TextStyle.Overline">Avg. Compliance Rate</RadzenText>
                            <RadzenText TextStyle="TextStyle.H5">@avgComplianceRate.ToString("N1")%</RadzenText>
                        </RadzenStack>
                    </RadzenColumn>
                    <RadzenColumn Size="3">
                        <RadzenStack Gap="0.5rem">
                            <RadzenText TextStyle="TextStyle.Overline">Total Value Traded</RadzenText>
                            <RadzenText TextStyle="TextStyle.H5">@totalValueTraded.ToString("C0")</RadzenText>
                        </RadzenStack>
                    </RadzenColumn>
                </RadzenRow>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>

    <RadzenRow>
        <RadzenColumn Size="12">
            <RadzenButton Icon="add_circle_outline" Text="New Monthly Report" Click="(() => ShowReportDialog(null))" ButtonStyle="ButtonStyle.Primary" />
        </RadzenColumn>
    </RadzenRow>

    <RadzenRow>
        <RadzenColumn Size="12">
            <RadzenDataGrid Data="@reports" TItem="MonthlyProcessingReport" AllowFiltering="true"
                           AllowSorting="true" AllowPaging="true" PageSize="10"
                           FilterMode="FilterMode.Advanced">
                <Columns>
                    <RadzenDataGridColumn TItem="MonthlyProcessingReport" Property="ReportNumber" Title="Report #" Width="120px" />
                    <RadzenDataGridColumn TItem="MonthlyProcessingReport" Property="ReportMonth" Title="Month" Width="100px" FormatString="{0:MM/yyyy}" />
                    <RadzenDataGridColumn TItem="MonthlyProcessingReport" Property="TotalTradesProcessed" Title="Trades" Width="80px" />
                    <RadzenDataGridColumn TItem="MonthlyProcessingReport" Property="TotalQuantityTraded" Title="Qty (MT)" Width="100px" FormatString="{0:N0}" />
                    <RadzenDataGridColumn TItem="MonthlyProcessingReport" Property="TotalValueTraded" Title="Value" Width="120px" FormatString="{0:C0}" />
                    <RadzenDataGridColumn TItem="MonthlyProcessingReport" Property="NewBuyersRegistered" Title="New Buyers" Width="100px" />
                    <RadzenDataGridColumn TItem="MonthlyProcessingReport" Property="NewSellersRegistered" Title="New Sellers" Width="100px" />
                    <RadzenDataGridColumn TItem="MonthlyProcessingReport" Property="InspectionsConducted" Title="Inspections" Width="100px" />
                    <RadzenDataGridColumn TItem="MonthlyProcessingReport" Property="ComplianceRate" Title="Compliance" Width="100px" FormatString="{0:N1}%" />
                    <RadzenDataGridColumn TItem="MonthlyProcessingReport" Property="Status" Title="Status" Width="100px">
                        <Template Context="report">
                            <RadzenBadge BadgeStyle="@GetStatusBadgeStyle(report.Status)" Text="@report.Status" />
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="MonthlyProcessingReport" Title="Actions" Width="100px" Sortable="false" Filterable="false">
                        <Template Context="report">
                            <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small"
                                         Click="(() => ShowReportDialog(report))" @onclick:stopPropagation="true" />
                            <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small"
                                         Click="(() => DeleteReport(report.Id))" @onclick:stopPropagation="true" />
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>
        </RadzenColumn>
    </RadzenRow>
</RadzenStack>

@code {
    IEnumerable<MonthlyProcessingReport> reports = new List<MonthlyProcessingReport>();

    int totalReports = 0;
    int finalizedReports = 0;
    decimal avgComplianceRate = 0;
    decimal totalValueTraded = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadReports();
    }

    private async Task LoadReports()
    {
        reports = await MonthlyProcessingReportService.GetAllMonthlyProcessingReportsAsync();
        CalculateSummary();
    }

    private void CalculateSummary()
    {
        totalReports = reports.Count();
        finalizedReports = reports.Count(r => r.Status == "Finalized");
        avgComplianceRate = reports.Any() ? reports.Average(r => r.ComplianceRate) : 0;
        totalValueTraded = reports.Sum(r => r.TotalValueTraded);
    }

    private async Task ShowReportDialog(MonthlyProcessingReport? report)
    {
        var selectedReport = report ?? new MonthlyProcessingReport { ReportMonth = DateTime.Now.AddMonths(-1), GeneratedDate = DateTime.Now };
        var isNew = report == null;

        var result = await DialogService.OpenAsync<MonthlyProcessingReportDialog>(
            isNew ? "Create New Monthly Report" : "Edit Monthly Report",
            new Dictionary<string, object> { { "Report", selectedReport } },
            new DialogOptions { Width = "800px", Height = "650px", Resizable = true, Draggable = true }
        );

        if (result is MonthlyProcessingReport savedReport)
        {
            if (isNew)
            {
                await MonthlyProcessingReportService.CreateMonthlyProcessingReportAsync(savedReport);
                NotificationService.Notify(NotificationSeverity.Success, "Report Created", $"Report {savedReport.ReportNumber} created successfully", 4000);
            }
            else
            {
                await MonthlyProcessingReportService.UpdateMonthlyProcessingReportAsync(savedReport);
                NotificationService.Notify(NotificationSeverity.Success, "Report Updated", $"Report {savedReport.ReportNumber} updated successfully", 4000);
            }
            await LoadReports();
        }
    }

    private async Task DeleteReport(string reportId)
    {
        var confirmed = await DialogService.Confirm("Are you sure you want to delete this monthly report?",
            "Delete Monthly Report");

        if (confirmed == true)
        {
            await MonthlyProcessingReportService.DeleteMonthlyProcessingReportAsync(reportId);
            NotificationService.Notify(NotificationSeverity.Warning, "Report Deleted", "Monthly report has been deleted", 4000);
            await LoadReports();
        }
    }

    private BadgeStyle GetStatusBadgeStyle(string status)
    {
        return status switch
        {
            "Draft" => BadgeStyle.Warning,
            "Finalized" => BadgeStyle.Success,
            "Approved" => BadgeStyle.Primary,
            _ => BadgeStyle.Light
        };
    }
}
