@page "/sellers"
@using Platform.Trading.Management.Models
@using Platform.Trading.Management.Services.Interfaces
@using Platform.Trading.Management.Components.Dialogs
@inject ISellerService SellerService
@inject DialogService DialogService
@inject NotificationService NotificationService

<PageTitle>Seller Management</PageTitle>

<RadzenStack Gap="1rem">
    <RadzenRow>
        <RadzenColumn Size="12">
            <RadzenText TextStyle="TextStyle.H3" TagName="TagName.H1">Seller Management</RadzenText>
            <RadzenText TextStyle="TextStyle.Body1">Manage registered sellers and their KYC status</RadzenText>
        </RadzenColumn>
    </RadzenRow>

    <RadzenRow>
        <RadzenColumn Size="12">
            <RadzenCard>
                <RadzenRow>
                    <RadzenColumn Size="3">
                        <RadzenStack Gap="0.5rem">
                            <RadzenText TextStyle="TextStyle.Overline">Total Sellers</RadzenText>
                            <RadzenText TextStyle="TextStyle.H5">@totalSellers</RadzenText>
                        </RadzenStack>
                    </RadzenColumn>
                    <RadzenColumn Size="3">
                        <RadzenStack Gap="0.5rem">
                            <RadzenText TextStyle="TextStyle.Overline">Approved Sellers</RadzenText>
                            <RadzenText TextStyle="TextStyle.H5" Style="color: green;">@approvedSellers</RadzenText>
                        </RadzenStack>
                    </RadzenColumn>
                    <RadzenColumn Size="3">
                        <RadzenStack Gap="0.5rem">
                            <RadzenText TextStyle="TextStyle.Overline">Pending KYC</RadzenText>
                            <RadzenText TextStyle="TextStyle.H5" Style="color: orange;">@pendingKycSellers</RadzenText>
                        </RadzenStack>
                    </RadzenColumn>
                    <RadzenColumn Size="3">
                        <RadzenStack Gap="0.5rem">
                            <RadzenText TextStyle="TextStyle.Overline">KYC Approved</RadzenText>
                            <RadzenText TextStyle="TextStyle.H5" Style="color: blue;">@kycApprovedSellers</RadzenText>
                        </RadzenStack>
                    </RadzenColumn>
                </RadzenRow>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>

    <RadzenRow>
        <RadzenColumn Size="12">
            <RadzenButton Icon="add_circle_outline" Text="Register New Seller" Click="(() => ShowSellerDialog(null))" ButtonStyle="ButtonStyle.Primary" />
        </RadzenColumn>
    </RadzenRow>

    <RadzenRow>
        <RadzenColumn Size="12">
            <RadzenDataList AllowVirtualization="false"
                            WrapItems="true" AllowPaging="true"
                            Data="@sellers" TItem="Seller" PageSize="5" PagerHorizontalAlign="HorizontalAlign.Left" ShowPagingSummary="true">
                <Template Context="seller">
                    <RadzenCard Variant="Variant.Outlined" class="rz-p-0" Style="width: 100%; overflow: hidden; margin-bottom: 1rem;">
                        <RadzenRow Gap="0">
                            <RadzenColumn Size="12" SizeLG="6" class="rz-p-4">
                                <RadzenText TextStyle="TextStyle.H6" TagName="TagName.H5" class="rz-color-on-secondary-lighter">@seller.CompanyName</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2">Contact: @seller.ContactPerson (@seller.Email)</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2">Location: @seller.City, @seller.Country</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2">Minerals: @string.Join(", ", seller.MineralsSold)</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2">Capacity: @seller.ProductionCapacityPerMonth.ToString("N0") MT/month</RadzenText>
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeLG="3" class="rz-p-4">
                                <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">
                                    <RadzenText TextStyle="TextStyle.Body1">Status: <RadzenBadge BadgeStyle="@GetStatusBadgeStyle(seller.Status)" Text="@seller.Status" /></RadzenText>
                                    <RadzenText TextStyle="TextStyle.Body1">KYC: <RadzenBadge BadgeStyle="@GetKYCStatusBadgeStyle(seller.KYCStatus)" Text="@seller.KYCStatus" /></RadzenText>
                                    <RadzenText TextStyle="TextStyle.Body1">Approved:
                                        @if (seller.IsApproved)
                                        {
                                            <RadzenIcon Icon="check_circle" IconStyle="IconStyle.Success" />
                                        }
                                        else
                                        {
                                            <RadzenIcon Icon="cancel" IconStyle="IconStyle.Danger" />
                                        }
                                    </RadzenText>
                                </RadzenStack>
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeLG="3" class="rz-p-4 rz-text-align-right">
                                <RadzenStack Orientation="Orientation.Vertical" JustifyContent="JustifyContent.SpaceAround" AlignItems="AlignItems.End" Gap="0.5rem">
                                    <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small"
                                                 Click="(() => ShowSellerDialog(seller))" @onclick:stopPropagation="true" />
                                    <RadzenButton Icon="verified_user" ButtonStyle="ButtonStyle.Success" Size="ButtonSize.Small"
                                                 Click="(() => ApproveSeller(seller.Id))" Disabled="@seller.IsApproved"
                                                 title="Approve Seller" @onclick:stopPropagation="true" />
                                    <RadzenButton Icon="gavel" ButtonStyle="ButtonStyle.Info" Size="ButtonSize.Small"
                                                 Click="(() => ShowKYCStatusDialog(seller))"
                                                 title="Update KYC Status" @onclick:stopPropagation="true" />
                                    <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small"
                                                 Click="(() => DeleteSeller(seller.Id))" @onclick:stopPropagation="true" />
                                </RadzenStack>
                            </RadzenColumn>
                        </RadzenRow>
                    </RadzenCard>
                </Template>
            </RadzenDataList>
        </RadzenColumn>
    </RadzenRow>
</RadzenStack>

@code {
    IEnumerable<Seller> sellers = new List<Seller>();

    int totalSellers = 0;
    int approvedSellers = 0;
    int pendingKycSellers = 0;
    int kycApprovedSellers = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadSellers();
    }

    private async Task LoadSellers()
    {
        sellers = await SellerService.GetAllSellersAsync();
        CalculateSummary();
    }

    private void CalculateSummary()
    {
        totalSellers = sellers.Count();
        approvedSellers = sellers.Count(s => s.IsApproved);
        pendingKycSellers = sellers.Count(s => s.KYCStatus == "Pending");
        kycApprovedSellers = sellers.Count(s => s.KYCStatus == "Approved");
    }

    private async Task ShowSellerDialog(Seller? seller)
    {
        var selectedSeller = seller ?? new Seller { RegistrationDate = DateTime.Now, LastKYCReviewDate = DateTime.Now };
        var isNew = seller == null;

        var result = await DialogService.OpenAsync<SellerDialog>(
            isNew ? "Register New Seller" : "Edit Seller",
            new Dictionary<string, object> { { "Seller", selectedSeller } },
            new DialogOptions { Width = "900px", Height = "700px", Resizable = true, Draggable = true }
        );

        if (result is Seller savedSeller)
        {
            if (isNew)
            {
                await SellerService.CreateSellerAsync(savedSeller);
                NotificationService.Notify(NotificationSeverity.Success, "Seller Registered", $"Seller {savedSeller.CompanyName} registered successfully", 4000);
            }
            else
            {
                await SellerService.UpdateSellerAsync(savedSeller);
                NotificationService.Notify(NotificationSeverity.Success, "Seller Updated", $"Seller {savedSeller.CompanyName} updated successfully", 4000);
            }
            await LoadSellers();
        }
    }

    private async Task ApproveSeller(string sellerId)
    {
        var confirmed = await DialogService.Confirm("Are you sure you want to approve this seller?",
            "Approve Seller");

        if (confirmed == true)
        {
            await SellerService.ApproveSellerAsync(sellerId);
            NotificationService.Notify(NotificationSeverity.Success, "Seller Approved", "Seller has been successfully approved", 4000);
            await LoadSellers();
        }
    }

    private async Task ShowKYCStatusDialog(Seller seller)
    {
        var result = await DialogService.OpenAsync<UpdateKYCStatusDialog>(
            "Update KYC Status",
            new Dictionary<string, object> { { "Seller", seller } },
            new DialogOptions { Width = "400px" }
        );

        if (result is string newKYCStatus && newKYCStatus != seller.KYCStatus)
        {
            await SellerService.UpdateKYCStatusAsync(seller.Id, newKYCStatus);
            NotificationService.Notify(NotificationSeverity.Success, "KYC Status Updated", $"KYC status for {seller.CompanyName} updated to {newKYCStatus}", 4000);
            await LoadSellers();
        }
    }

    private async Task DeleteSeller(string sellerId)
    {
        var confirmed = await DialogService.Confirm("Are you sure you want to delete this seller?",
            "Delete Seller");

        if (confirmed == true)
        {
            await SellerService.DeleteSellerAsync(sellerId);
            NotificationService.Notify(NotificationSeverity.Warning, "Seller Deleted", "Seller has been deleted", 4000);
            await LoadSellers();
        }
    }

    private BadgeStyle GetStatusBadgeStyle(string status)
    {
        return status switch
        {
            "Pending KYC" => BadgeStyle.Warning,
            "KYC Approved" => BadgeStyle.Success,
            "Approved" => BadgeStyle.Primary,
            "KYC Rejected" => BadgeStyle.Danger,
            _ => BadgeStyle.Light
        };
    }

    private BadgeStyle GetKYCStatusBadgeStyle(string kycStatus)
    {
        return kycStatus switch
        {
            "Pending" => BadgeStyle.Warning,
            "Reviewed" => BadgeStyle.Info,
            "Approved" => BadgeStyle.Success,
            "Rejected" => BadgeStyle.Danger,
            _ => BadgeStyle.Light
        };
    }
}
