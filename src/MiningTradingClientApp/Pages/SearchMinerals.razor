@page "/searchminerals"
@using MiningTradingClientApp.Models
@using MiningTradingClientApp.Services
@using System.Linq
@inject IMineralService MineralService

<PageTitle>Search Minerals</PageTitle>

<div class="page-container">
    <h1>Search Available Minerals</h1>

    <div class="search-input-group">
        <input type="text" class="search-input-field" placeholder="Enter mineral name, origin, or seller..." @bind-value="searchTerm" @onkeyup="HandleSearch" />
        <button class="btn btn-primary" type="button" @onclick="PerformSearch">Search</button>
    </div>

    @if (searchResults == null)
    {
        <div class="info-message">
            <em>Enter a search term to find minerals.</em>
        </div>
    }
    else if (!searchResults.Any())
    {
        <div class="warning-message">
            <em>No minerals found matching your search criteria.</em>
        </div>
    }
    else
    {
        <div class="card-container">
            @foreach (var mineral in searchResults)
            {
                <div class="card">
                    <img src="@mineral.ImageUrl" class="card-image" alt="@mineral.Name">
                    <div class="card-body">
                        <h5 class="card-title">@mineral.Name
                            @if (mineral.IsVerified)
                            {
                                <span class="verified-badge">Verified</span>
                            }
                        </h5>
                        <p class="card-text">@mineral.Description</p>
                        <ul class="card-details-list">
                            <li>
                                <span>Price:</span>
                                <strong>@mineral.Price.ToString("C")</strong>
                            </li>
                            <li>
                                <span>Weight:</span>
                                <span>@mineral.Weight kg</span>
                            </li>
                            <li>
                                <span>Origin:</span>
                                <span>@mineral.Origin</span>
                            </li>
                            <li>
                                <span>Seller:</span>
                                <span>@mineral.Seller</span>
                            </li>
                            <li>
                                <span>Listed:</span>
                                <span>@mineral.DateListed.ToShortDateString()</span>
                            </li>
                        </ul>
                        <div class="card-actions">
                            <a href="/order/@mineral.Id" class="btn btn-primary">Buy Now</a>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private string searchTerm = string.Empty;
    private IEnumerable<Mineral>? searchResults;

    private async Task PerformSearch()
    {
        searchResults = await MineralService.SearchMineralsAsync(searchTerm);
    }

    private async Task HandleSearch(KeyboardEventArgs e)
    {
        if (e.Code == "Enter" || e.Code == "NumpadEnter")
        {
            await PerformSearch();
        }
    }
}